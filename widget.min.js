const apiUrlBase="https://intensiv-widget.juliankern.com/beds",getApiUrl=(a,b)=>a?`${apiUrlBase}?lat=${a.latitude.toFixed(3)}&lng=${a.longitude.toFixed(3)}`:b?`${apiUrlBase}?state=${b}`:apiUrlBase,defaultCfg={layout:"simple"},CONFIG=Object.assign({},defaultCfg,arguments[0]);init();async function init(){const a=await createWidget();config.runsInWidget||(await a.presentSmall()),Script.setWidget(a),Script.complete()}async function createWidget(){const a=await getData(),b=new ListWidget,c=b.addText("\uD83D\uDECF Freie ITS-Betten");if(c.font=Font.mediumSystemFont(12),a){b.addSpacer();let c={overall:saveLoadData(a.overall,"DE")};a.state&&(c.state=saveLoadData(a.state,a.state.shortName),renderDatablock(b,a.state,c.state),b.addSpacer(4)),renderDatablock(b,a.overall,c.overall),b.refreshAfterDate=new Date(Date.now()+1800000),b.addSpacer(6);const d=new DateFormatter;d.useShortDateStyle(),d.useShortTimeStyle();const e=b.addText(`â†» ${d.string(new Date(a.overall.updated))}`);e.font=Font.regularSystemFont(9),e.textColor=Color.gray()}else b.addSpacer(),b.addText("Daten nicht verf\xFCgbar");return b}function renderDatablock(a,b,c){const d=a.addText(`${b.used.toFixed(2)}% ${getBedsTrend(b,c)}`);d.font=Font.mediumSystemFont(22),d.textColor=getPercentageColor(b.used);const e=a.addStack();if(e.layoutHorizontally(),e.centerAlignContent(),e.useDefaultPadding(),"extended"===CONFIG.layout){const a=e.addText((b.shortName||"DE")+" ");a.font=Font.semiboldSystemFont(10),a.textColor=Color.lightGray();const d=e.addText(`${b.absolute.free}/${b.absolute.total}`);d.font=Font.mediumSystemFont(10),d.textColor=getPercentageColor(b.used);const f=e.addText(getBedsTrendAbsolute(b,c));f.font=Font.mediumSystemFont(10),f.textColor=Color.gray()}else{const a=e.addText(b.name||"Deutschland");a.font=Font.lightSystemFont(12)}}function getPercentageColor(a){return 25>=a?Color.red():50>=a?Color.orange():Color.green()}async function getData(){try{let a;if(args.widgetParameter)a=await new Request(getApiUrl(null,args.widgetParameter)).loadJSON();else{const b=await getLocation();a=await new Request(getApiUrl(b)).loadJSON()}return a}catch(a){return null}}async function getLocation(){try{return Location.setAccuracyToThreeKilometers(),await Location.current()}catch(a){return null}}function getBedsTrend(a,b){let c=" ";if(0<Object.keys(b).length){const d=getDataForDate(b);d&&(c=a.absolute.free<d.absolute.free?"\u2193":"\u2191")}return c}function getBedsTrendAbsolute(a,b){if(0<Object.keys(b).length){const c=getDataForDate(b);if(c){const b=a.absolute.free-c.absolute.free;return 0<b&&(b=`+${b}`),` (${b})`}}return""}function getDataForDate(a,b=!0,c=""){let d=c,e=1;const f=new Date,g=`${f.getFullYear()}-${f.getMonth()+1}-${f.getDate()}`;return"undefined"==typeof a[g]&&(e=2),b&&(f.setDate(f.getDate()-e),d=`${f.getFullYear()}-${f.getMonth()+1}-${f.getDate()}`),"undefined"!=typeof a[d]&&a[d]}function saveLoadData(a,b=""){var c=Math.max;const d=a.updated.substr(0,10),e=loadData(b);if(e){e[d]=a;const f=Object.keys(e),g=f.slice(c(Object.keys(e).length-7,0));let h={};g.forEach(a=>h[a]=e[a]);const{fm:i,path:j}=getFM(b);return i.writeString(j,JSON.stringify(h)),e}return{}}function loadData(a){const{fm:b,path:c}=getFM(a);if(b.fileExists(c)){const a=b.readString(c);return JSON.parse(a)}return{}}function getFM(a){let b,c;try{b=FileManager.iCloud(),c=getFilePath(b,a)}catch(d){b=FileManager.local(),c=getFilePath(b,a)}return{fm:b,path:c}}function getFilePath(a,b){return a.joinPath(a.documentsDirectory(),`its-beds-${b}.json`)}